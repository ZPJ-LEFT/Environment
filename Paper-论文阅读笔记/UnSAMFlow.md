# UnSAMFlow: Unsupervised Optical Flow Guided by Segment Anything Model

## 摘要
传统的无监督光流方法对于遮挡和运动边界表现很差，这主要是因为缺少物体的整体信息，因此论文提出UnSAMFlow，一种利用最新SAM模型提取物体信息的无监督光流网络。

（1）论文首先引入自监督语义增强模块以处理SAM的Mask结果;
（2）论文也分析了传统平滑损失的梯度边界(poor gradient landscapes)，并提出一种基于同调性(homography)的新的平滑项定义;
（3）一个简单但有效的mask特征模块被用于聚合物体级特征。

通过这些应用，论文的方法能生成具有清晰物体边界的光流估计结果，在KITTI、Sintel上取得了最好的结果，并且该方法在不同域内泛化性强

## 引言
光流估计涉及寻找视频帧间的像素级对应，在视频理解、视频编辑、自动驾驶等领域具有广泛应用。

大多数光流估计方法都在监督学习框架下建模光流问题，利用真值标签训练网络。然而，在真实视频中获取标签是困难的，因为这通常需要在多个传感器间进行准确的校准，具有很高的注释成本，这一缺点使得这些有监督技术难以被大规模应用到实际场景。

由于注释成本太高，有许多工作研究了无监督光流模型，它们依赖于两个关键准则：
（1）亮度恒定假设：假设帧间对应点具有相似的局部上下文；
（2）平滑假设：光流场应保持空间平滑性。
然而，这些假设在遮挡区域（前景物体覆盖背景区域）以及运动边界（运动被突然截断）失效，这给无监督光流带来了巨大挑战。

根本而言，遮挡和运动边界的问题来源于光流的low-level特征，其中object-level特征通常缺失，为了更好地处理遮挡，理解物体间的空间关系和交互作用是非常重要的。此外，光流只能在同一连续物体区域内保持光滑，而在物体边缘附近允许sharp的运动边界。总之，object-level信息可以在细化无监督光流中发挥关键作用。

事实上，前人工作已经探索了object信息在光流中的应用，使用语义分割来帮助光流估计，然而语义分割虽方便，但并不精准，因为他不能区分同一语义类的不同实例，这些实例可能有不同的运动，并且它也受到所定义类的有限数量的限制，从而无法识别开放世界的新对象。

相比之下，最新的SAM模型可能是一个更好的选择，因为他是一个通用的分割模型，可以分割不同的实例并且在训练集上不具有的新物体上具有较好的zero-shot表现，此外SAMF可以检测不同尺度的物体。

因此，论文利用SAM提供的物体信息增强无监督光流，论文提出了三种改编方法：
（1）利用SemARFlow中的语义增强模块实现基于SAM掩膜的自监督；
（2）利用基于同质性的区域平滑损失，在每个SAM分割内增强平滑光流；
（3）设计了一个mask特征模块聚合来自相同SAM掩膜的特征。

## 相关工作

**（无监督光流）** 早期无监督光流利用光度损失、平滑损失监督，然后许多特定的改进模块被提出，包括遮挡感知调整、迭代细化、可学习上采样、自监督、数据集学习，最新的SMURF基于RAFT结构，实现了和那后的性能。

**（融合光流和物体信息）** 许多工作利用现成的语义实例分割模型作为线索增强光流，给定语义信息，多数方法对物体的刚性运动进行推理，如homography、epipolar gemoetry、SfM。SemARFlow是一种最新网络，它通过自监督在特征层面上整合了语义。此外，光流和语义分割的联合训练对两个任务有利。
对比SAMFlow，该论文关注的是无监督光流，并且论文方法利用了SAM的输出而非SAM特征，因此论文的网络可以被任何分割模型复用，只要它生成SAM风格的对象掩膜，这使得论文方法更加灵活。

## 方法

#### 两种方法定义
（1）仅利用SAM掩膜增强模型训练，也就是说测试时无需利用SAM
（2）将SAM掩膜输入到网络中

#### 网络结构

基于ARFlow构建网络，应用了一些SeARFlow的改进方法如可学习上采样。

**Encoder** 论文利用一个全卷积网络提取特征金字塔。

**Decoder** 论文采用一个类似SeARFlow的迭代优化模块，并且额外引入SAM的Mask作为输入。

**损失** 光度损失：输入帧F1,F2与扭曲后帧F2->1,F1->2之间的L1,SSIM,Census Loss三个损失的线性组合，遮挡区域通过双向连续性检测估计并且在计算光度损失时忽略；此外融合了语义增强损失和平滑损失。

#### 自监督语义增强
首先利用I1,I2估计光流F1->2，然后通过变形T1,T2将I1,I2转化为增强后的新输入i1,i2，根据T1,T2可以计算更新后的光流f1->2，利用该光流作为标签，基于L1损失监督i1,i2的光流估计结果，即语义增强损失。

变形T1,T2既包括ARFlow中提出的外形变换（光强、对比度、随机噪声）、二维仿射变换（平移、旋转、缩放）、遮挡增强（裁剪），也包括特殊的语义增强，即从一个随机样本中裁剪出物体并将其粘贴到另一个样本，同时添加一些简单运动。

#### 单应平滑损失
物体分割可以被用于制定更准确的平滑约束，以更好的规范光流场。

前人的平滑损失大多基于光流场的二阶导数，它们设置一个边界感知的权重来平衡物体边界的光流突变，论文中利用SAM提供更准确的边界，但是作者发现这些边界感知平滑的定义并不理想。

尽管当物体边界与光流边界重合时，平滑损失达到最优解，但是该解是一个非常陡峭的局部损失最小值，相比之下，该最优解附近的landscape都非常平坦，这意味着当前估计周围的任何局部值对损失影响不大，这使得训练很难陷入局部最优。

因此，论文提出基于对象区域，而非对象边界定义平滑度。利用RANSAC计算对象区域的单应矩阵，计算过程中剔除异常点，然后利用单应矩阵计算细化的光流f2，利用L1损失优化估计光流f1作为单应平滑损失。

值得一提的是，也可以利用单应矩阵的优化光流作为输出结果，但是这为模型推理额外引入了SAM和RANSAC的计算，从经验来看，用损失优化和直接后处理的效果是相同的。

## 精髓点
（1）模型训练：利用语义分割的Mask优化光流训练的Loss，包括ARFlow的自监督语义增强、单应平滑损失
（2）模型结构：将SAM的Mask特征输入到网络
（3）无监督训练
